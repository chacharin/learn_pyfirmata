# sensor_read.py
# à¸­à¹ˆà¸²à¸™à¸„à¹ˆà¸²à¸ˆà¸²à¸ Digital input (à¹€à¸Šà¹ˆà¸™à¸›à¸¸à¹ˆà¸¡à¸à¸”) à¹à¸¥à¸° Analog input (à¹€à¸Šà¹ˆà¸™ potentiometer)

from pyfirmata2 import Arduino, util   
import time

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸±à¸šà¸šà¸­à¸£à¹Œà¸” (à¹à¸à¹‰ 'COM11' à¹ƒà¸«à¹‰à¸•à¸£à¸‡à¸à¸±à¸šà¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“)
board = Arduino('COM11')
board.samplingOn(30)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ à¸ªà¸£à¹‰à¸²à¸‡ Iterator Thread à¹€à¸à¸·à¹ˆà¸­à¸ˆà¸±à¸”à¸à¸²à¸£ Serial Buffers
it = util.Iterator(board)
it.start()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ à¸à¸³à¸«à¸™à¸”à¸‚à¸²à¹€à¸›à¹‡à¸™ Input à¹à¸¥à¸°à¸›à¸£à¸°à¸à¸²à¸¨ Callback
# get_pin('d:9:s')
#  â€¢ 'd'  = digital pin
#  â€¢ 'a'  = analog pin
#  â€¢ '2'  = à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸‚à¸² D2 
#  â€¢ '0'  = à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸‚à¸² A0 
#  â€¢ 'i'  = input mode  (à¸£à¸±à¸šà¸„à¹ˆà¸²à¸ˆà¸²à¸à¹€à¸‹à¸™à¹€à¸‹à¸­à¸£à¹Œ)
button_pin = board.get_pin('d:2:i')   # Digital D2  (input)
poten_pin = board.get_pin('a:0:i')   # Analog  A0  (input)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Callback à¸Ÿà¸±à¸‡à¸„à¹Œà¸Šà¸±à¸™ 
def on_button(data):
    """
    à¸ˆà¸°à¸–à¸¹à¸à¹€à¸£à¸µà¸¢à¸à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆà¸ªà¸–à¸²à¸™à¸°à¸›à¸¸à¹ˆà¸¡à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ (0â†’1 à¸«à¸£à¸·à¸­ 1â†’0)
    :à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ à¸›à¸¸à¹ˆà¸¡à¸à¸”à¸à¸³à¸«à¸™à¸” data: 0.0 à¹€à¸¡à¸·à¹ˆà¸­à¸à¸”, 1.0 à¹€à¸¡à¸·à¹ˆà¸­à¸›à¸¥à¹ˆà¸­à¸¢
    """
    state = "à¸à¸”à¸­à¸¢à¸¹à¹ˆ" if data else "à¹„à¸¡à¹ˆà¸à¸”"
    print("ğŸŸ¦ à¸ªà¸–à¸²à¸™à¸°à¸›à¸¸à¹ˆà¸¡ D2:", state)

def on_poten(data):
    """
    à¸ˆà¸°à¸–à¸¹à¸à¹€à¸£à¸µà¸¢à¸à¸•à¸²à¸¡à¸­à¸±à¸•à¸£à¸² sampling à¸‚à¸­à¸‡ Arduino (à¸„à¹ˆà¸² 0.0-1.0)
    """
    voltage = data * 5.0                  # à¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™à¹‚à¸§à¸¥à¸•à¹Œ (à¸ªà¸¡à¸¡à¸•à¸´ Vref = 5 V)
    # à¹à¸ªà¸”à¸‡à¸œà¸¥à¹à¸šà¸šà¹€à¸£à¸µà¸¢à¸šà¸‡à¹ˆà¸²à¸¢ (à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰ f-string à¸‹à¸±à¸šà¸‹à¹‰à¸­à¸™)
    print("A0 =", round(data, 3), "â‰ˆ", round(voltage, 2), "V")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ Callback à¹à¸¥à¹‰à¸§à¹€à¸›à¸´à¸”à¸£à¸²à¸¢à¸‡à¸²à¸™ (enable_reporting)
button_pin.register_callback(on_button)
button_pin.enable_reporting()

poten_pin.register_callback(on_poten)
poten_pin.enable_reporting()

print("à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¹ˆà¸²à¸™ callback (à¸à¸” Ctrl-C à¹€à¸à¸·à¹ˆà¸­à¸«à¸¢à¸¸à¸”)")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ à¸§à¸™à¸„à¹‰à¸²à¸‡à¹„à¸§à¹‰à¹€à¸‰à¸¢ à¹†  (callback à¸ˆà¸°à¸—à¸³à¸‡à¸²à¸™à¹€à¸šà¸·à¹‰à¸­à¸‡à¸«à¸¥à¸±à¸‡)
try:
    while True:
        time.sleep(1)   # à¸«à¸™à¹ˆà¸§à¸‡à¸¢à¸²à¸§à¹„à¸”à¹‰ à¹€à¸à¸£à¸²à¸°à¹€à¸£à¸²à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹‚à¸à¸¥à¸¥à¹Œà¸„à¹ˆà¸²à¹€à¸­à¸‡
except KeyboardInterrupt:
    print("\n à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ªà¸±à¹ˆà¸‡à¸«à¸¢à¸¸à¸”à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™")
finally:
    board.exit()        # à¸›à¸´à¸”à¸à¸­à¸£à¹Œà¸•à¸­à¸¢à¹ˆà¸²à¸‡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢